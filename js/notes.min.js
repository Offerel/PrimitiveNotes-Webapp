function downloadNote(){let e=document.getElementById("fname").value,t="action=dlNote&note="+e,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let t=new Blob([n.response],{type:n.getResponseHeader("content-type")}),a=document.createElement("a");a.style="display: none",document.body.appendChild(a);let o=window.URL.createObjectURL(t);a.href=o,a.download=e,a.click(),window.URL.revokeObjectURL(o)}},n.open("POST",document.location.pathname,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(t)}function barwidth(){let e=document.getElementById("left").offsetWidth-1;var t=decodeURIComponent(document.cookie).split("; ");t.forEach(function(t){if(0===t.indexOf("primitivenotes")){let n=JSON.parse(t.substr(15)),a=new Date;a.setTime(a.getTime()+2592e6);let o="expires="+a.toUTCString();n.barw=e;let l=encodeURIComponent(JSON.stringify(n));document.cookie="primitivenotes="+l+"; SameSite=Strict; Secure; "+o+"; path="+location.href.substring(0,location.href.lastIndexOf("/")+1)}})}function manageDropUpload(e){addLoader();for(let t of e)filelist.push(t);doDropUpload()}function doDropUpload(){if(filelist.length>0){let e=new FormData,t=filelist[0];filelist.shift(),e.append("dropFile",t);let n=new XMLHttpRequest;n.open("POST",document.location.pathname),n.onload=function(){let e=JSON.parse(n.response);switch(console.info(t.name+" uploaded"),doDropUpload(),e){case 0:loadList();break;case 1:alert("Upload not successfull. Please check server log.");break;case 2:alert("File not allowed.")}},n.onerror=function(e){alert("There was an error during upload!"),console.error("There was an error during upload!"),doDropUpload()},n.send(e)}else removeLoader()}function oSource(){this.value.length>0&&window.open(this.value,"_blank").focus()}function addLoader(){let e=document.createElement("div");e.id="loader",document.getElementById("parent").appendChild(e);let t=document.createElement("div");t.id="loaderbg",document.getElementById("parent").appendChild(t)}function removeLoader(){document.getElementById("loader").remove(),document.getElementById("loaderbg").remove()}function deleteNote(e){let t="object"==typeof e?document.getElementById("fname").value:e,n="object"==typeof e;if(t.length<1)return void console.warn("No note to delete...");addLoader();let a="action=dNote&note="+t,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let e=JSON.parse(o.responseText);if(1==e.erg){if(removeLoader(),console.info(e.message),e.data.length>0){if(confirm(e.message)){let t="action=dMedia&media="+encodeURIComponent(JSON.stringify(e.data)),n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let e=JSON.parse(o.responseText);alert(e)}},n.open("POST",document.location.pathname,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(t)}n?window.location.href=document.location.pathname:loadList()}}else console.warn(e.message),removeLoader();n?window.location.href=document.location.pathname:loadList()}},o.open("POST",document.location.pathname,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(a)}function tpreview(){document.getElementById("tocButton")&&document.getElementById("tocButton").remove(),mde.isPreviewActive()?(document.getElementById("ntitle").disabled=!1,document.getElementById("author").readOnly=!1,document.getElementById("source").readOnly=!1,switchButtons("edit"),tagify.setReadonly(!1),document.querySelector("#noteheader .tagify").classList.add("tedit")):(document.getElementById("ntitle").disabled=!0,document.getElementById("author").readOnly=!0,document.getElementById("source").readOnly=!0,switchButtons("view"),tagify.setReadonly(!0),document.querySelector("#noteheader .tagify").classList.remove("tedit"),getTOC()),mde.togglePreview()}function togglemData(){document.getElementById("ndata").classList.toggle("mtoggle")}function showNote(){addLoader(),document.querySelectorAll("#nlist li").forEach(function(e){e.classList.remove("nloaded")});let e=this.dataset.na,t="action=vNote&note="+e+"&type="+this.children[0].title,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let o=n.responseText.split("---");removeLoader();var t,a={};if(o.length>1){let n=o[1].trim().split(/\r?\n/);n.forEach(function(e){let t=e.split(": ");a[t[0].trim()]=t[1].trim()}),t=o[2].trim(),document.getElementById("fname").value=e,document.getElementById("ntitle").value=a.title?a.title:e.split(".")[0];let l=a.tags?a.tags:"";document.getElementById("ntags").value=l,document.getElementById("author").value=a.author?a.author:"",document.getElementById("date").value=a.date?a.date:"",document.getElementById("updated").value=a.updated?a.updated:"",document.getElementById("source").value=a.source?a.source:"",tagify.removeAllTags(),tagify.addTags(l.split(" ")),document.querySelector("[data-na='"+e+"']").classList.toggle("nloaded")}else t=o[0].trim(),document.getElementById("fname").value=e,document.getElementById("ntitle").value=e.substr(0,e.lastIndexOf(".")),document.getElementById("ntags").value="",document.getElementById("author").value="",document.getElementById("date").value="",document.getElementById("updated").value="",document.getElementById("source").value="",tagify.removeAllTags();window.document.title=cval.title+" - "+document.getElementById("ntitle").value,a.source?document.getElementById("source").classList.add("iurl"):document.getElementById("source").classList.remove("iurl"),document.getElementById("ndata").classList.add("mtoggle"),mde.value(t),mde.isPreviewActive()||mde.togglePreview(),document.getElementById("ntitle").disabled=!0,document.getElementById("author").readOnly=!0,document.getElementById("source").readOnly=!0,switchButtons("view"),tagify.setReadonly(!0),document.querySelector("#noteheader .tagify").classList.remove("tedit"),getTOC()}},n.open("POST",document.location.pathname,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(t)}function getTOC(){document.getElementById("tocButton")&&document.getElementById("tocButton").remove();let e=document.querySelectorAll("h1, h2, h3, h4, h5, h6");if(e.length>0){let t=document.createElement("button");t.id="tocButton",t.innerText="ToC",document.getElementById("noteheader").appendChild(t);let n=document.createElement("div");n.id="tocDIV";let a=0,o=0,l="c%";e.forEach(function(e){o=e.tagName.substr(1,1),l=a<o?l.replace("c%",'<li><ul><li><a title="'+e.innerText+'" href="#'+e.id+'">'+e.innerText+"</a></li>c%</ul></li>"):a>o?l.replace("c%",'</ul><li><a title="'+e.innerText+'" href="#'+e.id+'">'+e.innerText+"</a></li>c%"):l.replace("c%",'<li><a title="'+e.innerText+'" href="#'+e.id+'">'+e.innerText+"</a></li>c%"),a=o}),l=l.replace("c%</ul>",""),n.innerHTML=l,t.addEventListener("click",function(e){e.preventDefault(),n.classList.toggle("tdhidden")}),document.getElementById("tocDIV")&&document.getElementById("tocDIV").remove(),document.querySelector(".EasyMDEContainer").appendChild(n),document.querySelectorAll("#tocDIV a").forEach(function(e){e.addEventListener("click",function(){n.classList.toggle("tdhidden")})})}}function searchList(){var e,t,n,a,o;for(e=document.getElementById("nsearch"),t=e.value.toUpperCase(),n=document.getElementById("nlist"),a=n.getElementsByTagName("li"),o=0;o<a.length;o++)liTags=a[o].dataset.tags,liTags.toUpperCase().indexOf(t)>-1?a[o].style.display="":a[o].style.display="none"}function uplLocalImage(){document.getElementById("localFile").click()}function uplInsertImage(){addLoader();let e=prompt("URL of the image","");if(!e)return!1;{let t="action=uplImage&imageURL="+e,n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&200==this.status&&(removeLoader(),mde.codemirror.replaceSelection("![]("+n.responseText+")"))},n.open("POST",document.location.pathname,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(t)}}function switchButtons(e){let t=document.querySelectorAll("#notebody .editor-toolbar button");document.querySelector(".ma-download").disabled=""===document.getElementById("fname").value,t.forEach(function(t,n){"view"==e?(document.querySelector("button.New.ma").style.display="inline-block",document.querySelector("button.Save.ma").style.display="none",0==t.classList.contains("no-disable")&&t.classList.add("ma-disabled")):(document.querySelector("button.New.ma").style.display="none",document.querySelector("button.Save.ma").style.display="inline-block",0==t.classList.contains("no-disable")&&t.classList.remove("ma-disabled"))})}function newNote(){document.getElementById("tocButton")&&document.getElementById("tocButton").remove(),document.getElementById("fname").value="",document.getElementById("ntitle").value="",document.getElementById("ntitle").disabled=!1,document.getElementById("ntags").value="",document.getElementById("author").value="",document.getElementById("author").readOnly=!1,document.getElementById("date").value="",document.getElementById("updated").value="",document.getElementById("source").value="",document.getElementById("source").readOnly=!1,mde.value(""),tagify.removeAllTags(),tagify.setReadonly(!1),document.querySelector("#noteheader .tagify").classList.add("tedit"),switchButtons("edit"),window.document.title=cval.title+" - New"}function saveNote(){addLoader();let e=document.getElementById("fname").value;e=e.split(".");let t=tagify.value,n=[];for(let e in t)n.push(t[e].value);var a={nname:document.getElementById("ntitle").value,oname:e[0],type:e[1]?e[1]:"md",tags:n,content:mde.value(),author:document.getElementById("author").value?document.getElementById("author").value:null,date:document.getElementById("date").value?document.getElementById("date").value:null,source:document.getElementById("source").value?document.getElementById("source").value:null};let o="action=sNote&note="+encodeURIComponent(JSON.stringify(a)),l=new XMLHttpRequest;l.onreadystatechange=function(){if(4==this.readyState&&200==this.status){l.responseText;removeLoader(),document.getElementById("ntitle").disabled=!0,document.getElementById("author").readOnly=!0,document.getElementById("source").readOnly=!0,switchButtons("view"),tagify.setReadonly(!0),document.querySelector("#noteheader .tagify").classList.remove("tedit"),getTOC(),mde.togglePreview(),loadList()}},l.open("POST",document.location.pathname,!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(o)}function loadList(){let e="action=gNlist",t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let e=JSON.parse(t.responseText),n=document.querySelectorAll("#nlist li");n.forEach(function(e){e.remove()}),document.getElementById("nlist").innerHTML=e,document.querySelectorAll("#nlist li").forEach(e=>e.addEventListener("click",showNote)),document.querySelectorAll("#nlist li").forEach(e=>e.addEventListener("contextmenu",onContextMenu)),document.getElementById("nlist").addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),document.getElementById("nlist").addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),document.getElementById("nlist").classList.remove("highlight"),manageDropUpload(e.dataTransfer.files)})}},t.open("POST",document.location.pathname,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(e)}function uploadFile(e,t="",n=""){if(addLoader(),"srcElement"in e)var a=e.srcElement.files[0];else a=e;var o=new XMLHttpRequest;o.onload=function(){200==o.status?(n&&(n=' "'+n+'"'),mde.codemirror.replaceSelection("!["+t+"]("+o.responseText+n+")"),removeLoader()):(alert("Error! Upload failed"),console.error("Error! Upload failed"))},o.onerror=function(){alert("Error! Upload failed"),console.error("Error! Upload failed. Can not connect to server.")};var l=new FormData;l.append("localFile",a),o.open("POST",document.location.pathname,!0),o.send(l)}function pasteParse(e){function t(e,t,n){var a=new XMLHttpRequest;a.onload=function(){200==a.status?(n&&(n=' "'+n+'"'),mde.codemirror.replaceSelection("!["+t+"]("+a.responseText+n+")")):console.error("Error! Upload failed"),removeLoader()},a.onerror=function(){console.error("Error! Upload failed. Can not connect to server."),removeLoader()};var o=new FormData;o.append("localFile",e),a.open("POST",document.location.href,!0),a.send(o)}e.preventDefault(),e.stopPropagation();const n=e.clipboardData.getData("text/html")||e.clipboardData.getData("text/plain");for(var a=0;a<e.clipboardData.items.length;a++){let n=e.clipboardData.items[a];if(-1!=n.type.indexOf("image")){let a=e.clipboardData.getData("text/html");if(a.indexOf('alt="')>=0){let e=a.indexOf('alt="')+5,t=a.indexOf('"',e);var o=a.substr(e,t-e)}else o="";if(a.indexOf('title="')>=0){let e=a.indexOf('title="')+7,t=a.indexOf('"',e);var l=a.substr(e,t-e)}else l="";return addLoader(),t(n.getAsFile(),o,l),!1}}let d={headingStyle:"atx",hr:"-",bulletListMarker:"-",codeBlockStyle:"fenced",fence:"```",emDelimiter:"*",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",collapseMultipleWhitespaces:!0,preformattedCode:!0},i=new window.TurndownService(d);i.addRule("kbd",{filter:["kbd"],replacement:function(e){return"<kbd>"+e+"</kbd>"}});let c=n.startsWith("<html>")?i.turndown(n):n;if(c.startsWith("---")){let e=c.split("\n"),t=c.indexOf("---",4)+3;for(let t=1;t<10&&"---"!=e[t];t++){let n=e[t].split(":");"title"==n[0]&&(document.getElementById("ntitle").value=n[1].trim()),"tags"==n[0]&&tagify.addTags(n[1]),"author"==n[0]&&(document.getElementById("author").value=n[1].trim()),"date"==n[0]&&(document.getElementById("date").value=n.slice(1).join(":").trim()),"updated"==n[0]&&(document.getElementById("updated").value=n.slice(1).join(":").trim()),"source"==n[0]&&(document.getElementById("source").value=n.slice(1).join(":").trim())}c=c.substr(t).trim()}mde.codemirror.replaceSelection(c)}function onContextMenu(e){e.preventDefault(),confirm("Do you want to delete '"+this.title+"'?")&&deleteNote(this.dataset.na)}function logOut(){console.info("Try to Logout...");let e="action=logout",t=new XMLHttpRequest;t.onreadystatechange=function(){4==this.readyState&&200==this.status&&(window.location.href=window.location.pathname)},t.open("POST",document.location.pathname,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(e)}var mde,tagify,cval,filelist=[];document.addEventListener("DOMContentLoaded",function(){document.getElementById("lform")&&(document.getElementById("user").focus(),document.querySelector("html").classList.add("login"));let e=decodeURIComponent(document.cookie).split("; ");if(e.forEach(function(e){0==e.indexOf("primitivenotes=")&&(cval=JSON.parse(e.substring(15)))}),document.querySelectorAll("#nlist li").forEach(e=>e.addEventListener("click",showNote)),document.querySelectorAll("#nlist li").forEach(e=>e.addEventListener("contextmenu",onContextMenu)),document.getElementById("left")&&(document.getElementById("left").style.width=cval.barw?cval.barw+"px":"",new ResizeObserver(barwidth).observe(document.getElementById("left"))),document.getElementById("nlist")){var t=!1;document.getElementById("nlist").addEventListener("dragenter",function(e){e.preventDefault(),e.stopPropagation(),t=!0,setTimeout(function(){t=!1},1),document.getElementById("nlist").classList.add("highlight")}),document.getElementById("nlist").addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),!1===t&&document.getElementById("nlist").classList.remove("highlight")}),document.getElementById("nlist").addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),document.getElementById("nlist").addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),document.getElementById("nlist").classList.remove("highlight"),manageDropUpload(e.dataTransfer.files)})}tagify=new Tagify(document.getElementById("ntags"),{whitelist:[],dropdown:{classname:"color-blue",enabled:0,maxItems:0,position:"text",closeOnSelect:!1,highlightFirst:!0},trim:!0,duplicates:!1,enforceWhitelist:!1,delimiters:",|;| ",placeholder:"Tags"}),mde=new EasyMDE({element:document.getElementById("notesarea"),spellChecker:!1,previewImagesInEditor:!1,autofocus:!1,promptURLs:!0,inputStyle:"contenteditable",nativeSpellcheck:!0,indentWithTabs:!0,sideBySideFullscreen:!1,autoDownloadFontAwesome:!1,renderingConfig:{codeSyntaxHighlighting:!0,sanitizerFunction:function(e){return e.replaceAll(cval.mf,document.location.pathname+"?nimg=")}},shortcuts:{Preview:"Cmd-P"},toolbar:[{name:"Save",className:"ma ma-save",action:saveNote,title:"Save",noDisable:!0},{name:"New",className:"ma ma-new",action:newNote,title:"New",noDisable:!0},"|",{name:"Bold",className:"ma ma-bold",action:EasyMDE.toggleBold,title:"Bold"},{name:"Italic",className:"ma ma-italic",action:EasyMDE.toggleItalic,title:"Italic"},{name:"Striketrough",className:"ma ma-strikethrough",title:"Striketrough",action:EasyMDE.toggleStrikethrough},{name:"Clean block",className:"ma ma-clean",title:"Clean block",action:EasyMDE.cleanBlock},"|",{name:"Heading",className:"ma ma-heading",title:"Heading",action:EasyMDE.toggleHeading1},"|",{name:"Code",className:"ma ma-code",title:"Code",action:EasyMDE.toggleCodeBlock},{name:"Quote",className:"ma ma-quote",title:"Quote",action:EasyMDE.toggleBlockquote},{name:"List",className:"ma ma-glist",title:"List",children:[{name:"Generic List",action:EasyMDE.toggleUnorderedList,className:"ma ma-glist",title:"Generic List"},{name:"Numbered List",action:EasyMDE.toggleOrderedList,className:"ma ma-olist",title:"Numbered List"}]},"|",{name:"Link",className:"ma ma-link",title:"Create Link",action:EasyMDE.drawLink},{name:"Image",className:"ma ma-image",title:"Image",children:[{name:"RImage",action:uplInsertImage,className:"ma ma-image",title:"Insert Image URL"},{name:"LImage",action:uplLocalImage,className:"ma ma-limage",title:"Upload Image"}]},{name:"Table",className:"ma ma-table",title:"Insert table",action:EasyMDE.drawTable},"|",{name:"Preview",className:"ma ma-preview",title:"Toggle Preview",action:tpreview,noDisable:!0},{name:"SideBySide",className:"ma ma-sidebyside",title:"Toggle Side by Side",action:EasyMDE.toggleSideBySide},"|",{name:"Delete",className:"ma ma-delete",title:"Delete Note",action:deleteNote,noDisable:!0},{name:"Guide",className:"ma ma-guide",title:"Markdown Guide",action:"https://www.markdownguide.org/basic-syntax/",noDisable:!0},{name:"Download",className:"ma ma-download",title:"Download Note",action:downloadNote,noDisable:!0},{name:"Meta",className:"ma ma-meta",action:togglemData,title:"Display Metadata",noDisable:!0},"|",{name:"LogoutB",className:"ma ma-logout",action:logOut,title:"Logout",noDisable:!0}]}),document.querySelector(".EasyMDEContainer")&&(document.querySelector(".EasyMDEContainer").addEventListener("paste",pasteParse,!0),document.getElementById("source").addEventListener("click",oSource),document.getElementById("nsearch").addEventListener("keyup",searchList,!1),document.getElementById("localFile").addEventListener("change",uploadFile,!1),switchButtons("edit"),document.getElementById("ntitle").value="",tagify.removeAllTags(),document.getElementById("author").value="",document.getElementById("author").readOnly=!1,document.getElementById("date").value="",document.getElementById("updated").value="",document.getElementById("source").value="",document.getElementById("source").readOnly=!1,tagify.settings.whitelist=document.getElementById("allTags").value.split(","))},!1);